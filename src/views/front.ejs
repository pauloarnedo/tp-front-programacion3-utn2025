<%- include("partials/head.ejs") %>
<%- include("partials/nav.ejs") %>

    <hr>
        <h1><%= title %></h1>
    <hr>

    <main id="contenedor-get">
        <section class="seccion-productos">
            <!--<label for="orden">Ordenar por:</label>
            <select id="orden">
            <option value="">Seleccionar</option>
            <option value="az">Nombre A-Z</option>
            <option value="za">Nombre Z-A</option>
            <option value="precio-asc">Precio m√°s bajo</option>
            <option value="precio-desc">Precio m√°s alto</option>
            </select>-->

            <div id="productos-container">
                <ul id="productos-lista">
    
                    <% products.forEach(prod => {  %>

                        <li class="li-listados productos-listados">
                            <img src=" <%= prod.image %> " alt=" <%= prod.name %> " class="img-listados">
                            <h3><%= prod.name %></h3>
                            <p><strong>$<%= prod.price %></strong></p>
                            <button onclick='agregarAlCarrito(<%- JSON.stringify(prod) %>)'>Agregar a carrito</button>
                        </li> 

                    <% }) %>
                </ul>
            </div>
            <nav class="paginacion">
                <% if (page > 1) { %>
                    <div class="navBlock"><a href="?page=<%= page - 1 %>">&lt; Anterior</a></div>
                <% } else {%>
                    <div class="navBlock" style="visibility:hidden;">&lt; Anterior</div>
                <% }%>

                <div class="navBlock numbers">
                <% for (let i = 1; i <= pages; i++) { %>
                    <% if (i === page) { %>
                    <strong><%= i %></strong>
                    <% } else { %>
                    <a href="?page=<%= i %>"><%= i %></a>
                    <% } %>
                <% } %>
                </div>

                <% if (page < pages) { %>
                    <div class="navBlock"><a href="?page=<%= page + 1 %>">Siguiente &gt;</a></div>
                <% } else {%>
                    <div class="navBlock" style="visibility:hidden;">Siguiente &gt;</div>
                <% }%>
            </nav>
        </section>
        <section class="seccion-carrito">
            <hr>
            <h2 class="titulo-carrito">Carrito</h2>
            <hr>
            <div id="carrito-container"></div>
        </section>
    </main>

    <script>
    //Ordenamiento de productos. Esto va en el back o se elimina
    document.getElementById("orden").addEventListener("change", function () {
        const tipoOrden = this.value;
        const lista = document.getElementById("productos-lista");
        const items = Array.from(lista.querySelectorAll("li"));

        items.sort((a, b) => {
        const nombreA = a.querySelector("h3").textContent.trim().toLowerCase();
        const nombreB = b.querySelector("h3").textContent.trim().toLowerCase();
        const precioA = parseFloat(a.querySelector("p").textContent.replace(/[^0-9.]/g, ""));
        const precioB = parseFloat(b.querySelector("p").textContent.replace(/[^0-9.]/g, ""));

        switch (tipoOrden) {
            case "az":
            return nombreA.localeCompare(nombreB);
            case "za":
            return nombreB.localeCompare(nombreA);
            case "precio-asc":
            return precioA - precioB;
            case "precio-desc":
            return precioB - precioA;
            default:
            return 0;
        }
        });

        // Limpiamos y reinsertamos los elementos ordenados
        lista.innerHTML = "";
        items.forEach(item => lista.appendChild(item));
    });

function agregarAlCarrito(producto) {
  // Recuperar el carrito del sessionStorage (o crear uno vac√≠o)
  let carrito = JSON.parse(sessionStorage.getItem("carrito")) || [];

  // Buscar si el producto ya est√° en el carrito
  let productoExistente = carrito.find(item => item.id === producto.id);

  if (productoExistente) {
    productoExistente.quantity++; // aumentar la cantidad
  } else {
    producto.quantity = 1; // si es nuevo, agregar cantidad inicial
    carrito.push(producto);
  }

  // Guardar carrito actualizado en sessionStorage
  sessionStorage.setItem("carrito", JSON.stringify(carrito));

  // Mostrar los productos en pantalla
  mostrarCarrito();
}

function mostrarCarrito() {
  const carrito = JSON.parse(sessionStorage.getItem("carrito")) || [];
  const contenedor = document.getElementById("carrito-container");

  contenedor.innerHTML = "";

  if (carrito.length === 0) {
    contenedor.innerHTML = "<p>El carrito est√° vac√≠o.</p>";
    return;
  }

  let tabla = document.createElement("table");
  tabla.innerHTML = `
    <thead>
      <tr>
        <th>Imagen</th>
        <th>Producto</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Total</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      ${carrito
        .map(item => `
          <tr>
            <td><img src="${item.image}" alt="${item.name}" width="50"></td>
            <td>${item.name}</td>
            <td>$${item.price}</td>
            <td>${item.quantity}</td>
            <td>$${(item.quantity * parseFloat(item.price)).toFixed(2)}</td>
            <td>
              <button onclick="actualizarCantidad(${item.id}, 'restar')">-</button>
              <button onclick="actualizarCantidad(${item.id}, 'sumar')">+</button>
              <button onclick="eliminarProducto(${item.id})">üóëÔ∏è</button>
            </td>
          </tr>
        `)
        .join("")}
    </tbody>
  `;

  contenedor.appendChild(tabla);
  const total = carrito.reduce((acc, item) => acc + item.quantity * parseFloat(item.price), 0);
const totalTexto = document.createElement("p");
totalTexto.innerHTML = `<strong>Total del carrito: $${total.toFixed(2)}</strong>`;
contenedor.appendChild(totalTexto);
}

function actualizarCantidad(id, accion) {
  let carrito = JSON.parse(sessionStorage.getItem("carrito")) || [];

  const producto = carrito.find(item => item.id === id);
  if (!producto) return;

  if (accion === "sumar") {
    producto.quantity++;
  } else if (accion === "restar") {
    producto.quantity--;
    if (producto.quantity <= 0) {
      // Si la cantidad queda en 0, lo quitamos del carrito
      carrito = carrito.filter(item => item.id !== id);
    }
  }

  sessionStorage.setItem("carrito", JSON.stringify(carrito));
  mostrarCarrito();
}

function eliminarProducto(id) {
  let carrito = JSON.parse(sessionStorage.getItem("carrito")) || [];
  carrito = carrito.filter(item => item.id !== id);
  sessionStorage.setItem("carrito", JSON.stringify(carrito));
  mostrarCarrito();
}
    </script>
<%- include("partials/footer.ejs") %>